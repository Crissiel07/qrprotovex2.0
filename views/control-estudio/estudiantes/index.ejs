<h1 class="mt-4">Gestión de Estudiantes</h1>
<p class="lead mb-4">Administra los registros de estudiantes del sistema</p>

<div class="row">
  <div class="col-md-5">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Registrar Nuevo Estudiante</h5>
      </div>
      <div class="card-body">
        <form action="/control-estudio/estudiantes/create" method="POST" id="createStudentForm" data-toast-success="Estudiante registrado exitosamente" data-toast-error="Error al registrar estudiante" class="needs-validation" novalidate>
          
          <!-- Información Personal -->
          <h5 class="border-bottom pb-2 mb-3">Información Personal</h5>
          
          <div class="form-group">
            <label for="cedula">Cédula de Identidad</label>
            <input
              type="text"
              id="cedula"
              name="cedula"
              class="form-control"
              placeholder="Ej: V-12345678"
              required
              data-toast-empty="La cédula es obligatoria"
            />
            <div class="invalid-feedback">La cédula es obligatoria</div>
          </div>
          
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="nombres">Nombres</label>
              <input
                type="text"
                id="nombres"
                name="nombres"
                class="form-control"
                placeholder="Nombres"
                required
                data-toast-empty="Los nombres son obligatorios"
              />
              <div class="invalid-feedback">Los nombres son obligatorios</div>
            </div>
            <div class="form-group col-md-6">
              <label for="apellidos">Apellidos</label>
              <input
                type="text"
                id="apellidos"
                name="apellidos"
                class="form-control"
                placeholder="Apellidos"
                required
                data-toast-empty="Los apellidos son obligatorios"
              />
              <div class="invalid-feedback">Los apellidos son obligatorios</div>
            </div>
          </div>
          

          

          
          <div class="form-group">
            <label for="email">Correo Electrónico</label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-control"
              placeholder="correo@ejemplo.com"
            />
            <div class="invalid-feedback">El correo electrónico es obligatorio</div>
          </div>
          

          
          <!-- Información Académica -->
          <h5 class="border-bottom pb-2 mb-3 mt-4">Información Académica</h5>
          
          <div class="form-group">
            <label for="carrera">Carrera</label>
            <select class="form-control" id="carrera" name="carrera" required data-toast-empty="La carrera es obligatoria">
              <option value="" disabled selected>Seleccione</option>
              <option value="Ingeniería de Sistemas">Ingeniería de Sistemas</option>
              <option value="Ingeniería Civil">Ingeniería Civil</option>
              <option value="Ingeniería Industrial">Ingeniería Industrial</option>
              <option value="Administración">Administración</option>
              <option value="Contaduría">Contaduría</option>
              <option value="Derecho">Derecho</option>
              <option value="Medicina">Medicina</option>
              <option value="Enfermería">Enfermería</option>
            </select>
            <div class="invalid-feedback">Debe seleccionar una carrera</div>
          </div>

          <div class="form-group">
            <label for="tipoEstudiante">Tipo de Estudiante</label>
            <select class="form-control" id="tipoEstudiante" name="tipoEstudiante" required data-toast-empty="El tipo de estudiante es obligatorio" onchange="mostrarTipoBeca()">
              <option value="" disabled selected>Seleccione</option>
              <option value="Particulado">Particulado</option>
              <option value="Becado">Becado</option>
            </select>
            <div class="invalid-feedback">Debe seleccionar el tipo de estudiante</div>
          </div>

          <div class="form-group" id="divTipoBeca" style="display: none;">
            <label for="tipoBeca">Tipo de Beca</label>
            <select class="form-control" id="tipoBeca" name="tipoBeca" data-toast-empty="El tipo de beca es obligatorio para estudiantes becados">
              <option value="" disabled selected>Seleccione</option>
              <option value="Beca Gel">Beca Gel</option>
              <option value="Simon Rodriguez">Simon Rodriguez</option>
            </select>
            <div class="invalid-feedback">Debe seleccionar el tipo de beca</div>
          </div>
          

          
          <div class="form-group">
            <label for="estado">Estado</label>
            <select class="form-control" id="estado" name="estado" required data-toast-empty="El estado es obligatorio">
              <option value="Activo" selected>Activo</option>
              <option value="Inactivo">Inactivo</option>
              <option value="Egresado">Egresado</option>
              <option value="Retirado">Retirado</option>
            </select>
            <div class="invalid-feedback">Debe seleccionar un estado</div>
          </div>
          
          <!-- Estados de pago (solo para estudiantes particulados) -->
          <div id="divEstadosPago" class="mt-3">
            <h5>Estados de Pago</h5>
            <div class="form-row">
              <div class="col-md-3 mb-3">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="inscripcion" name="inscripcion" value="true">
                  <label class="custom-control-label" for="inscripcion">Inscripción</label>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="primeraCuota" name="primeraCuota" value="true">
                  <label class="custom-control-label" for="primeraCuota">Primera Cuota</label>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="segundaCuota" name="segundaCuota" value="true">
                  <label class="custom-control-label" for="segundaCuota">Segunda Cuota</label>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="terceraCuota" name="terceraCuota" value="true">
                  <label class="custom-control-label" for="terceraCuota">Tercera Cuota</label>
                </div>
              </div>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary btn-block mt-4" id="submitBtn">Registrar Estudiante</button>
          <div class="mt-3" id="formFeedback"></div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-md-7">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Estudiantes Registrados</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="studentsTable">
            <thead>
              <tr>
                <th>Cédula</th>
                <th>Nombre</th>
                <th>Carrera</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <% if(typeof students != 'undefined' && students.length > 0) { %>
                <% students.forEach(function(student) { %>
                  <tr>
                    <td><%= student.cedula %></td>
                    <td><%= student.nombres %> <%= student.apellidos %></td>
                    <td><%= student.carrera %></td>
                    <td>
                      <% if(student.tipoEstudiante === 'Becado') { %>
                        <span class="badge badge-primary">Becado - <%= student.tipoBeca %></span>
                      <% } else { %>
                        <span class="badge badge-secondary">Particulado</span>
                      <% } %>
                    </td>
                    <td>
                      <% let statusClass = 'badge-secondary'; %>
                      <% if(student.estado === 'Activo') { statusClass = 'badge-success'; } %>
                      <% if(student.estado === 'Inactivo') { statusClass = 'badge-warning'; } %>
                      <% if(student.estado === 'Egresado') { statusClass = 'badge-info'; } %>
                      <% if(student.estado === 'Retirado') { statusClass = 'badge-danger'; } %>
                      <span class="badge <%= statusClass %>"><%= student.estado %></span>
                    </td>
                    <td>
                      <a href="/control-estudio/estudiantes/view/<%= student._id %>" class="btn btn-info btn-sm" title="Ver detalles"><i class="fas fa-eye"></i></a>
                      <a href="/control-estudio/estudiantes/edit/<%= student._id %>" class="btn btn-warning btn-sm" title="Editar"><i class="fas fa-edit"></i></a>
                      <button type="button" class="btn btn-danger btn-sm delete-student" data-toggle="modal" data-target="#deleteStudentModal" data-id="<%= student._id %>" data-name="<%= student.nombres + ' ' + student.apellidos %>" data-cedula="<%= student.cedula %>" title="Eliminar"><i class="fas fa-trash"></i></button>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="6" class="text-center">No hay estudiantes registrados</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar estudiante -->
<div class="modal fade" id="deleteStudentModal" tabindex="-1" role="dialog" aria-labelledby="deleteStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteStudentModalLabel"><i class="fas fa-exclamation-triangle"></i> Confirmar eliminación</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar al estudiante <strong id="deleteStudentName"></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-circle"></i> Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <a href="#" id="confirmDeleteBtn" class="btn btn-danger">Eliminar Estudiante</a>
      </div>
    </div>
  </div>
</div>

<div class="mt-3">
  <a href="/control-estudio" class="btn btn-secondary mr-2"><i class="fas fa-arrow-left"></i> Volver al Panel de Control de Estudio</a>
</div>

<script>
  // Script para manejar la eliminación de estudiantes con modal
  document.addEventListener('DOMContentLoaded', function() {
    // Cuando se hace clic en el botón de eliminar
    $('.delete-student').on('click', function() {
      // Obtener datos del estudiante a eliminar
      var studentId = $(this).data('id');
      var studentName = $(this).data('name');
      var studentCedula = $(this).data('cedula');
      
      // Actualizar el modal con los datos del estudiante
      $('#deleteStudentName').text(studentName + ' (' + studentCedula + ')');
      $('#confirmDeleteBtn').attr('href', '/control-estudio/estudiantes/delete/' + studentId);
      
      // Mostrar notificación toast
      if (typeof showWarningToast === 'function') {
        showWarningToast('¿Estás seguro de eliminar a ' + studentName + '?');
      }
    });
    
    // Cuando se confirma la eliminación
    $('#confirmDeleteBtn').on('click', function() {
      if (typeof showInfoToast === 'function') {
        showInfoToast('Procesando eliminación...');
      }
    });
    
    // Función para mostrar/ocultar el campo de tipo de beca según el tipo de estudiante
    window.mostrarTipoBeca = function() {
      const tipoEstudiante = document.getElementById('tipoEstudiante').value;
      const divTipoBeca = document.getElementById('divTipoBeca');
      const tipoBeca = document.getElementById('tipoBeca');
      
      if (tipoEstudiante === 'Becado') {
        divTipoBeca.style.display = 'block';
        tipoBeca.required = true;
      } else {
        divTipoBeca.style.display = 'none';
        tipoBeca.required = false;
        tipoBeca.value = '';
      }
    };

    const tipoEstudianteSelect = document.getElementById('tipoEstudiante');
    const tipoBecaDiv = document.getElementById('divTipoBeca');
    const tipoBecaSelect = document.getElementById('tipoBeca');
    const estadosPagoDiv = document.getElementById('divEstadosPago');
    
    tipoEstudianteSelect.addEventListener('change', function() {
      if (this.value === 'Becado') {
        tipoBecaDiv.style.display = 'block';
        tipoBecaSelect.setAttribute('required', 'required');
        estadosPagoDiv.style.display = 'none'; // Ocultar estados de pago para becados
      } else {
        tipoBecaDiv.style.display = 'none';
        tipoBecaSelect.removeAttribute('required');
        estadosPagoDiv.style.display = 'block'; // Mostrar estados de pago para particulados
      }
    });
    
    // Trigger the change event to set initial state
    tipoEstudianteSelect.dispatchEvent(new Event('change'));
  });
</script>
